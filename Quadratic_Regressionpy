import os
import cv2
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import PolynomialFeatures
from sklearn.metrics import mean_squared_error


csv_path = "C:/Users/dipali/OneDrive/Desktop/ratings.csv"
image_folder = "C:/Users/dipali/OneDrive/Desktop/images"


df = pd.read_csv(csv_path)
df.columns = ['Name', 'Label']


features = []
labels = []

for _, row in df.iterrows():
    fname = str(row["Name"]).strip()
    if fname.isdigit():
        fname = f"{int(fname):03}.jpg"
    if not fname.lower().endswith((".jpg", ".jpeg", ".png")):
        continue

    path = os.path.join(image_folder, fname)
    img = cv2.imread(path, cv2.IMREAD_GRAYSCALE)
    if img is None:
        continue
    img = cv2.resize(img, (20, 20))
    brightness = np.mean(img) / 255.0
    features.append([brightness])
    labels.append(row["Label"])

X = np.array(features)
y = np.array(labels)


poly = PolynomialFeatures(degree=2)
X_poly = poly.fit_transform(X)


model = LinearRegression()
model.fit(X_poly, y)
y_pred = model.predict(X_poly)


coeffs = model.coef_      
intercept = model.intercept_
a = coeffs[2]
b = coeffs[1]
c = intercept


mse = mean_squared_error(y, y_pred)
print(f" Quadratic equation fitted: y = {a:.4f}x² + {b:.4f}x + {c:.4f}")
print(f" Mean Squared Error: {mse:.4f}")

plt.figure(figsize=(8, 5))


plt.scatter(y, y, c='green', marker='x', label='Actual', zorder=3)


plt.scatter(y, y_pred, c='blue', label='Predicted', zorder=2)

for actual, pred in zip(y, y_pred):
    plt.plot([actual, actual], [actual, pred], 'gray', linewidth=0.5, zorder=1)


plt.plot([0, 1], [0, 1], 'r--', label='Perfect Prediction (y=x)', zorder=0)

plt.xlabel('Actual Rating')
plt.ylabel('Predicted Rating')
plt.title(f'Actual vs Predicted Ratings\nFitted: y = {a:.2f}x² + {b:.2f}x + {c:.2f}')
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()